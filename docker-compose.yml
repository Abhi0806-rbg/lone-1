services:
  # ----------------------------------------------------
  # 1. MongoDB Database
  # ----------------------------------------------------
  mongo:
    image: mongo:6.0
    container_name: lone1-mongo
    restart: always
    environment:
      MONGO_INITDB_DATABASE: lone1
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - lone1_network

  # ----------------------------------------------------
  # 2. Backend API Gateway Service
  # ----------------------------------------------------
  backend-api:
    build:
      context: ./backend-api-service
    container_name: lone1-backend-api
    restart: always
    depends_on:
      - mongo
      - ml-predictor
    environment:
      MONGO_URI: mongodb://mongo:27017/lone1
      JWT_SECRET_KEY: "supersecretkey"
      ML_PREDICTOR_URL: http://ml-predictor:8001
      ML_TRAINER_URL: http://ml-trainer:8002
    ports:
      - "8000:8000"
    networks:
      - lone1_network

  # ----------------------------------------------------
  # 3. ML Predictor Microservice
  # ----------------------------------------------------
  ml-predictor:
    build:
      context: ./ml-predictor-service
    container_name: lone1-ml-predictor
    restart: always
    environment:
      MODEL_PATH: /app/model/model.pkl
    volumes:
      - model_volume:/app/model
    ports:
      - "8001:8001"
    networks:
      - lone1_network

  # ----------------------------------------------------
  # 4. ML Trainer Microservice
  # ----------------------------------------------------
  ml-trainer:
    build:
      context: ./ml-trainer-service
    container_name: lone1-ml-trainer
    restart: always
    depends_on:
      - mongo
    environment:
      MONGO_URI: mongodb://mongo:27017/lone1
      MODEL_OUTPUT_PATH: /app/model/model.pkl
    volumes:
      - model_volume:/app/model
    ports:
      - "8002:8002"
    networks:
      - lone1_network

  # ----------------------------------------------------
  # 5. Frontend React Application
  # ----------------------------------------------------
  frontend:
    build:
      context: ./frontend
    container_name: lone1-frontend
    restart: always
    depends_on:
      - backend-api
    ports:
      - "3000:80"
    networks:
      - lone1_network

# --------------------------------------------------------
# Volumes
# --------------------------------------------------------
volumes:
  mongo_data:
  model_volume:

# --------------------------------------------------------
# Network
# --------------------------------------------------------
networks:
  lone1_network:
    driver: bridge
